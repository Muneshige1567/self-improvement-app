# 06. 通知システム

> **前提文書**: `ios-requirements.md` v2.0, `feedback-business-logic.md` v1.0, `requirements-review.md` v1.0
> **本セクションの位置づけ**: 通知タイムライン、リッチ通知仕様、ディープリンク設計の完全版

---

## 6.1 通知の設計思想

ユーザー（= 立花宗茂）の1日に寄り添い、立花一門の人物が**適切なタイミングで適切な役割で**語りかける。

通知は「行動を促すトリガー」であり、通知単体で情報を完結させない。アプリ内での深い体験（サマリー、詳細分析）への導線として機能する。

---

## 6.2 通知タイムライン（1日の流れ）

| 時間帯 | 通知名 | 送り主 | 内容 | 目的 | デフォルト時刻 |
|---|---|---|---|---|---|
| **朝** | 朝の檄文 | 立花道雪（養父） | 今日意識すべきカテゴリ | 1日のセットアップ。意識を方向づける | 07:00 |
| **昼** | 陣中見舞い | 家臣（由布惟信 等） | 軽い声かけ | 午後の行動を促す。存在感を維持 | 12:30 |
| **夜** | 夕べの下知 | 誾千代（妻） | チェック入力誘導 | チェック入力への誘導 | 22:00 |
| **入力直後** | 講評 | 状況依存 | スコアフィードバック | 行動強化 / 反省促進 | （即時） |
| **翌朝** | 前日総括 | 高橋紹運（実父） | 深い助言 | 内省と次の行動への接続 | 07:00 |
| **週次** | 週次総括 | 立花道雪（養父） | 7日間の総括 | 中期的な振り返り | 日曜 21:00 |

全通知時刻はユーザー設定で変更可能。各通知はオン/オフ個別設定可能。

### 6.2.1 朝の檄文（道雪）

```
トリガー: 毎朝（設定時刻 or 07:00）
送り主: 立花道雪
内容決定ロジック:
  1. 前日の記録がある場合:
     → 前日の lowestCategory に言及し、今日の意識ポイントとする
  2. 前日の記録がない場合:
     → 一般的な今日の心構え
  3. マイルストーン到達日の翌朝:
     → マイルストーンの祝福を含む

通知例:
  「宗茂よ、今日は"眼"を研ぎ澄ませよ。
   戦場では一瞬の油断が命取りじゃ」

  「宗茂よ、昨日は"剣"が冴えておったな。
   今日は"知"にも目を向けよ」
```

### 6.2.2 陣中見舞い（家臣団）

```
トリガー: 毎日昼（設定時刻 or 12:30）
送り主: 家臣団（由布惟信、十時連貞 等をランダム選択）
内容: 短い声かけ（朝の檄文の内容を軽くリマインド）

通知例:
  「殿、午後もお供いたしまする。朝の教えを忘れずに」
  「殿、由布惟信にございます。午後の戦、共に参りましょう」
```

### 6.2.3 夕べの下知（誾千代）

```
トリガー: 毎夜（設定時刻 or 22:00）
条件: 当日まだ記録していない場合のみ送信
送り主: 誾千代
内容: チェック入力への誘導

通知例:
  「今日の戦はどうであった。逃げずに振り返りなさい」
  「あなた、まだ記録をつけていないでしょう。
   立花の名に恥じぬ振り返りを」

アクションボタン: 「Quick開始」「Deep開始」「後で」
```

### 6.2.4 講評（状況依存）

```
トリガー: チェック入力完了直後
送り主: フィードバックタイプに応じてキャラクター決定
  praise  → 道雪
  rebuke  → 誾千代
  encourage → 家臣団
  advise  → 道雪
  celebrate → 全員
  warn    → 紹運
内容: 05_feedback.md の即時フィードバック判定結果に基づく

※ アプリがフォアグラウンドにある場合はプッシュ通知を送らず、
  アプリ内サマリー画面で直接フィードバックを表示する
```

### 6.2.5 前日総括（紹運）

```
トリガー: 翌朝（設定時刻 or 07:00、朝の檄文の直前）
条件: 前日の記録がある場合のみ
送り主: 高橋紹運
内容: 前日の振り返り + 今日への接続

通知例:
  「我が息子よ、昨日の"剣"は見事であった。
   だが"道"を忘れるな」

  「宗茂よ、昨日は苦しい一日であったようだな。
   だが苦しみの中にこそ、成長の種がある」
```

### 6.2.6 週次総括（道雪）

```
トリガー: 毎週（設定曜日・時刻 or 日曜 21:00）
送り主: 立花道雪
内容: 今週のハイライト + 来週のフォーカス推奨

通知例:
  「宗茂よ、今週の総括を申すぞ。
   "剣"が最も冴えておったが、"道"に課題が残る。
   来週は"意図的な学習"に意識を向けよ」
```

---

## 6.3 ストリーク通知

ユーザー（= 宗茂）の歩みを、立花家の歴史になぞらえて祝福する。

| マイルストーン | 日数 | 送り主 | 通知例 |
|---|---|---|---|
| **初陣** | 7 | 道雪 | 「七日。まずは初陣を果たしたな、宗茂よ。」 |
| **立花山城** | 30 | 道雪 | 「三十日。お主に立花の城を任せた甲斐があった。」 |
| **西国無双** | 66 | 紹運 | 「六十六日。我が息子よ、お主はもう"西国無双"だ。」 |
| **碧蹄館** | 100 | 誾千代 | 「百日......認めてやる。あなたは確かに強くなった。」 |
| **柳川帰還** | 200 | 家臣団 | 「殿、二百日。我ら一同、どこまでもお供いたす。」 |
| **天下無双** | 365 | 全員 | 道雪・紹運・誾千代・家臣団、一門総出の特別メッセージ |

天下無双（365日）達成時のみ、特別な複数通知を段階的に送信:
1. 道雪: 「一年。お主の中に、もう"道"が刻まれておる。」
2. 紹運: 「我が息子よ、お主は約束を守った。」
3. 誾千代: 「一年......認めます。あなたは天下無双です。」
4. 家臣団: 「殿、我ら一同、涙が止まりませぬ。」

---

## 6.4 iOSリッチ通知仕様

### 6.4.1 通知カテゴリ

| カテゴリID | 用途 | アクションボタン |
|---|---|---|
| `dailyReminder` | 夕べの下知（入力誘導） | 「Quick開始」「Deep開始」「後で」 |
| `feedback` | 講評（即時フィードバック） | 「詳細を見る」「閉じる」 |
| `milestone` | マイルストーン達成 | 「達成を見る」「閉じる」 |
| `morning` | 朝の檄文 / 前日総括 | 「記録を見る」「閉じる」 |
| `weekly` | 週次総括 | 「週次サマリーを見る」「閉じる」 |
| `midday` | 陣中見舞い | なし（情報提供のみ） |

### 6.4.2 通知表示仕様

| 項目 | 仕様 |
|---|---|
| サムネイル | キャラクターアイコン（送り主に応じて変化） |
| サウンド | デフォルト無音。設定で和風サウンド選択可 |
| グルーピング | スレッドID でキャラクター別にグループ化 |
| バッジ | 未入力日のみバッジ表示（入力完了で消去） |

### 6.4.3 スレッドID設計

```
スレッドID: "tachibana_{characterId}"

characterId:
  - dosetsu   → 立花道雪
  - joun      → 高橋紹運
  - ginchiyo  → 誾千代
  - kashin    → 家臣団

結果: 通知センターでキャラクターごとにグループ化される
  → 道雪からの通知がまとまる、誾千代の通知がまとまる等
```

### 6.4.4 通知アクションの実装

```swift
// UNNotificationCategory の定義
let dailyReminder = UNNotificationCategory(
    identifier: "dailyReminder",
    actions: [
        UNNotificationAction(identifier: "quickStart", title: "Quick開始"),
        UNNotificationAction(identifier: "deepStart", title: "Deep開始"),
        UNNotificationAction(identifier: "later", title: "後で")
    ],
    intentIdentifiers: []
)

// アクション処理
switch action.identifier {
case "quickStart":
    navigate(to: .checkInput(mode: .quick))
case "deepStart":
    navigate(to: .checkInput(mode: .deep))
case "later":
    // 30分後に再通知をスケジュール
    scheduleReminder(after: 30.minutes)
}
```

---

## 6.5 通知ディープリンク設計

通知タップ時に適切な画面に遷移する。

### 6.5.1 ディープリンクマッピング

| 通知タイプ | タップ時の遷移先 | 備考 |
|---|---|---|
| 朝の檄文 | ホーム画面 | 今日の入力を促す |
| 陣中見舞い | ホーム画面 | 軽い声かけなので深い画面には遷移しない |
| 夕べの下知 | モード選択画面（Quick/Deep） | アクションボタンでモード直接選択も可能 |
| 講評（即時） | デイリーサマリー（当日分） | フィードバック詳細も閲覧可能 |
| 前日総括 | デイリーサマリー（昨日分） | 前日のスコアとフィードバックを表示 |
| 週次総括 | 週次サマリー画面 | 7日間の総括を表示 |
| マイルストーン | マイルストーン達成画面 | 特別演出付きの達成表示 |
| リマインド（後で） | モード選択画面 | 再通知からの遷移 |

### 6.5.2 ディープリンクURL設計

```
URL Scheme: checklist://

checklist://home                          → ホーム画面
checklist://check/quick                   → Quick入力画面
checklist://check/deep                    → Deep入力画面
checklist://summary/{yyyy-MM-dd}          → デイリーサマリー（指定日）
checklist://summary/today                 → デイリーサマリー（今日）
checklist://summary/yesterday             → デイリーサマリー（昨日）
checklist://weekly/{yyyy-MM-dd}           → 週次サマリー（指定週）
checklist://weekly/latest                 → 最新の週次サマリー
checklist://milestone/{milestoneType}     → マイルストーン達成画面
checklist://settings                      → 設定画面
```

### 6.5.3 アプリ未起動時の挙動

```
IF アプリがコールドスタート（プロセスが存在しない）:
  → アプリを起動
  → スプラッシュ画面表示
  → ディープリンク先に直接遷移（ホーム画面を経由しない）
  → バックスタックにホーム画面を積む（戻るボタンでホームに戻れるように）

IF アプリがバックグラウンド:
  → フォアグラウンドに復帰
  → ディープリンク先に遷移
```

---

## 6.6 通知スケジューリング

### 6.6.1 ローカル通知のスケジュール

```
アプリ起動時 or 設定変更時に、翌日分のローカル通知をスケジュールする。

スケジュール対象:
- 朝の檄文: UNCalendarNotificationTrigger（毎日、設定時刻）
- 陣中見舞い: UNCalendarNotificationTrigger（毎日、設定時刻）
- 夕べの下知: UNCalendarNotificationTrigger（毎日、設定時刻）
- 週次総括: UNCalendarNotificationTrigger（毎週、設定曜日・時刻）

スケジュール対象外（動的生成）:
- 講評（即時）: チェック完了時にアプリ内で直接表示
- 前日総括: 翌朝の通知として朝の檄文と同時にスケジュール
- マイルストーン: ストリーク更新時に次のマイルストーン到達日を計算してスケジュール
```

### 6.6.2 条件付き通知の抑制

```
夕べの下知（入力誘導）の抑制:
  IF 当日すでに記録済み:
    → UNUserNotificationCenter.removePendingNotificationRequests(withIdentifiers:)
    → 通知を削除

  実装方針:
    チェック完了時にペンディング中の夕べの下知通知を削除する
```

### 6.6.3 AI生成通知のタイミング

```
AI生成が必要な通知:
- 朝の檄文: 前日の記録がある場合、翌朝の通知テキストをAI生成
- 前日総括: 同上
- 週次総括: 週末にAI生成

生成タイミング:
- チェック完了時に翌朝分のAI通知テキストを事前生成
- 週次は金曜〜日曜の間に事前生成
- 生成済みテキストをローカルに保存し、通知スケジュール時に使用

フォールバック:
- AI生成に失敗した場合はテンプレートベースの通知テキストを使用
```

---

## 6.7 通知設定UI

設定画面で以下の項目をユーザーが制御できる。

| 設定項目 | デフォルト値 | 備考 |
|---|---|---|
| 朝の檄文（オン/オフ） | オン | |
| 朝の檄文（時刻） | 07:00 | 時刻ピッカー |
| 陣中見舞い（オン/オフ） | オン | |
| 陣中見舞い（時刻） | 12:30 | 時刻ピッカー |
| 夕べの下知（オン/オフ） | オン | |
| 夕べの下知（時刻） | 22:00 | 時刻ピッカー |
| 前日総括（オン/オフ） | オン | 朝の檄文と同時刻 |
| 週次総括（オン/オフ） | オン | |
| 週次総括（曜日） | 日曜 | 曜日ピッカー |
| 週次総括（時刻） | 21:00 | 時刻ピッカー |
| マイルストーン通知 | オン | オフにはできない（常にオン推奨。UIでは非表示） |
| 通知サウンド | 無音 | 無音 / 鈴 / 太鼓 |

### 通知権限が拒否された場合

```
IF 通知権限が .denied:
  → 設定画面の通知セクションに警告バナーを表示
    「通知が無効です。設定アプリで通知を許可してください」
  → タップで UIApplication.openSettingsURLString を起動
  → リマインド通知以外のアプリ機能は通常通り動作
```

---

## 6.8 通知の文字数制限と表示仕様

| 表示場所 | タイトル | 本文 |
|---|---|---|
| ロック画面 | 20文字以内 | 40文字以内（1行表示） |
| 通知センター | 20文字以内 | 40文字以内 |
| バナー（短縮） | 20文字以内 | 40文字以内 |
| バナー（展開） | 20文字以内 | 120文字まで表示可能 |
| 3D Touch / 長押し | 20文字以内 | 200文字まで + アクションボタン |

通知テキストの生成時は**40文字以内**を基本とし、展開時に追加情報を表示する設計。

```
タイトル: 送り主の名前
  例: 「立花道雪」「誾千代」「由布惟信」

本文（短縮表示 / 40文字以内）:
  例: 「宗茂よ、今日は"眼"を研ぎ澄ませよ。」

本文（展開表示 / 最大200文字）:
  例: 「宗茂よ、今日は"眼"を研ぎ澄ませよ。
       昨日は"知"に課題が残っておった。
       今日こそ、一次ソースに当たり、
       自らの目で確かめる姿勢を忘れるな。」
```

---

## 6.9 キャラクター段階解放と通知の連携

通知の送り主はキャラクター段階解放（04_characters.md 4.4）に連動する。未解放のキャラクターは通知に登場しない。

### 6.9.1 解放前の代理ルール

| 通知 | 本来の送り主 | 解放前の代理 | 解放日数 |
|---|---|---|---|
| 朝の檄文 | 道雪 | —（1日目から解放済み） | 1日目 |
| 陣中見舞い | 家臣団（ローテーション） | 道雪 | 由布: 14日目、残り: 66日目 |
| 夕べの下知 | 誾千代 | 道雪 | 7日目 |
| 前日総括 | 紹運 | 道雪 | 30日目 |
| 週次総括 | 道雪 | —（1日目から解放済み） | 1日目 |

### 6.9.2 解放イベント通知

キャラクター解放時に専用の通知を送信する（04_characters.md 4.4.1 の登場演出セリフを使用）。

```
解放トリガー: ストリーク日数がキャラクター解放閾値に到達
通知カテゴリ: milestone
アクション: タップでフルスクリーンの解放演出モーダルを表示
```

---

## 6.10 AI生成通知仕様

### 6.10.1 生成対象

| 通知タイプ | テンプレートベース | AI生成 | 備考 |
|---|---|---|---|
| 朝の檄文 | MVP（デフォルト） | APIキー設定時 | 前日スコアを入力コンテキストに含む |
| 陣中見舞い | MVP（デフォルト） | APIキー設定時 | 朝の檄文の内容を踏まえた短い声かけ |
| 夕べの下知 | MVP（デフォルト） | APIキー設定時 | 当日の入力状態を考慮 |
| 即時講評 | フォールバック | v1.0（メイン） | 05_feedback.md 5.6 参照 |
| 前日総括 | フォールバック | v1.0（メイン） | 前日スコア全体を入力コンテキストに含む |
| 週次総括 | フォールバック | v1.1 | 7日分のスコアデータを入力コンテキストに含む |
| マイルストーン | 常にテンプレート | — | 固定セリフ。歴史的正確性を担保するためAI生成しない |

### 6.10.2 通知用プロンプト設計

```
system:
  あなたは{character_name}です。
  {character_personality_and_tone_rules}

  制約:
  - 40文字以内で1文を書くこと
  - 必ず{character_pronoun}の口調で書くこと
  - 現代語のカタカナ語は使わないこと
  - カテゴリは武士道呼称を使うこと（眼・知・剣・人・道）

user:
  通知タイプ: {notification_type}
  前日スコア: 総合 {total_avg}、最高 {best_cat}({best_score})、最低 {worst_cat}({worst_score})
  ストリーク: {streak_days}日連続
  今日の重点カテゴリ: {focus_category}
```

### 6.10.3 AI通知のバッチ生成

```
チェック完了時:
  → 翌朝の「前日総括」テキストをAI生成
  → 翌朝の「朝の檄文」テキストをAI生成
  → 翌日の「陣中見舞い」テキストをAI生成
  → 生成済みテキストを FeedbackCache に保存
  → 通知スケジュール時にキャッシュからテキストを取得

週次（金曜〜日曜の間）:
  → 日曜の「週次総括」テキストをAI生成（v1.1）

フォールバック:
  → AI生成失敗 or オフライン or APIキー未設定の場合
  → テンプレートベースの通知テキストを使用
  → ユーザーにはフォールバックであることを明示しない
```

### 6.10.4 AI通知のキャッシュ

```
キャッシュキー: {logicalDate}_{notificationType}_{characterId}
有効期限: 同一論理日付内
再生成条件:
  - 同日に再入力（UPSERT）した場合、翌朝分のキャッシュを破棄して再生成
  - 週次サマリーは日曜まで有効
```

### 6.10.5 プライバシー

Claude API に送信するデータは 05_feedback.md 5.6.4 のポリシーに準拠する。メモ本文は送信しない。

---

## 6.11 通知テンプレート数（MVP見積もり）

| 通知タイプ | テンプレート数 | 説明 |
|---|---|---|
| 朝の檄文 | 7 | カテゴリ別5 + データなし1 + 前日高スコア1 |
| 陣中見舞い | 6 | 家臣5人分 + 道雪代理1 |
| 夕べの下知 | 4 | 通常/連続未入力/ストリーク維持/解放前 |
| 即時講評 | 05_feedback.md参照 | notification チャネルのテンプレート群 |
| 前日総括 | 5 | 条件分岐5パターン（記録あり高/低/なし長短/ストリーク危機） |
| マイルストーン | 6 | マイルストーン6種 |
| キャラクター解放 | 5 | 解放イベント5種（7/14/30/66/100日目） |
| **合計（通知固有）** | **33** | AI生成が動作しない場合に使用 |
